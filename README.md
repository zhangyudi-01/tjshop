# 目录结构

```
.
│  .gitignore
│  main.py
│  README.md
│  requirements.txt
│  settings.py
│
├─apis
│
├─common
│  │  api.py
│  │  data.py
│  │  ……
│
├─data
│  │
│  ├─template
│  │
│  └─tmp
│
└─testsuites
```

## 说明

- `apis`: 接口类
- `common`: 公用方法，按照业务建立子模块
  - `data.py`: 数据相关方法
  - ……
- `data`：测试数据文件夹，接口测试数据按照接口构建的流水线服务名建立子文件夹
  - `template`: 存放数据模板文件
- `testsuites`：测试用例文件夹，按照接口构建的流水线名建立子文件夹
- `tools`: 工具类脚本，与测试无关。
- `.gitignore`: git 忽略文件
- `requirements.txt`: 依赖文件
- `setting.py`: 项目配置
- `main.py`: 调试用，可建立自己的调试文件，然后在.gitignore 中添加
- `pytest.ini`: pytest 配置文件
- `add_develop_tags.ps1`: 为测试脚本添加develop分支标签，在develop分支上执行。
- `add_master_tags.ps1`: 为测试脚本添加master分支标签，在develop分支上执行。
- `tags.txt`: 存放测试脚本的标签。需要保证/前面的服务名不重复。

## 接口测试说明

Python版本：3.12

### 测试用例

测试用例采用数据驱动，包含两部分：

1. Excel 文件，作为用例的驱动，模板：`data\template\接口测试用例.xlsx`，每个字段有说明。
2. 测试脚本，控制如何执行 Excel 文件，放于`testsuite`文件夹中。

### 编写方式

1. 根据需求和设计，编写 Excel 文件，包含测试内容、参数、预期等可以确定的内容，这一阶段为测试用例编写、数据准备。
2. 在研发接口设计完成后，根据 Excel 编写脚本，并根据脚本更新 Excel 文件，主要是处理数据。脚本说明如下：

#### 脚本构成

脚本主要由`处理数据`、`用例脚本`组成：

- 处理数据：一个生成器`generator`或函数`function`，建议使用生成器，可统计执行时间。测试用例excel文件的`处理数据`列写了每个用例对应的处理方法。
  - 生成器`yield`之前为前置数据处理方法，在调用接口之前执行，一般用于对用例字典`case_dict`进行处理和准备测试环境、数据。
  - yield 会返回接口调用后的`actual_result`，类型为字典。可以在断言前进行修改。
  - yield 之后，对测试数据进行还原，例如前置中临时修改比赛状态，后置中修改回去。还原后，可进行数据的判断，或者使用 try……finally 保证执行数据还原。
- 用例脚本：pytest 的执行方法，以`test_`开头，参数至少包含接口夹具(在`conftest.py`中定义)、用例变量。通过装饰器读取 Excel 文件的用例，读取结果为一个列表，每一项为`CaseDict`字典。
  - 脚本主要调用接口的`test`方法。可以看到`处理数据`的前置和后置都是在 test 里面执行的，所以一些公用的处理，除了可以写到夹具中，也可以写到用例脚本中。

### 执行顺序

1. 读取 Excel 文件，生成用例列表。
2. 前置方法准备测试数据。
3. 处理数据的yield调用接口，获取响应内容。
4. 处理数据的后置方法可以处理响应内容、还原测试数据、判断数据正确性。
5. 后置方法还原测试数据、判断数据正确性。
6. 判断接口返回状态码、响应时间、响应内容是否符合预期。

其中，2、3、4、5为人工编写脚本内容，如果没有指定处理数据，则跳过3、4步。

### 注意事项

1. 接口测试用例的编写，需要考虑接口的输入输出、异常情况、边界情况等。
2. 接口测试用例的执行，需要考虑接口的可用性、稳定性、响应时间等。
3. Excel文件，遇到全为空的行即停止读取。

### 写作思路
1. 先在excel中写测试用例，再写测试脚本。测试用例确认测试点、流程，对处理数据进行初步规划。
2. 确认测试对象的基类，基类中包含调用、测试的通用方法。如api基类在common.api中，然后在apis中写待测接口类，继承基类，并对接口定制化。如果是服务的话，也是同样思路。
3. 根据测试对象建立test_文件夹和文件。
4. 根据测试用例编写测试脚本，最基本的是test_方法，测试对象和用例列表作为入参，规划前置、后置，实现`处理数据`中的方法，并完善测试用例。
5. 调试脚本。